{% extends "master.html" %}

{% block title %}
    Dodaj nowego gościa
{% endblock %}

{% block header %}
    Dodaj nowego gościa
{% endblock %}

{% block content %}
    <style>
        body {font-family: Arial, Helvetica, sans-serif;}
        
        /* The Modal (background) */
        .details-modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        
        /* Modal Content */
        .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        }
        
        /* The Close Button */
        .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
        }
    </style>

    <div id="main-form">
        <label for="company-name">Nazwa firmy</label>
        <input list="companies" id="companies-list">
            <datalist id="companies">
                {% for company in companies_data %}
                    <option value="{{company.name}}">
                {% endfor %}
            </datalist>
        <!-- <input type="text" id="company-name"> -->
    
        <label for="register-nb">Numer rejestracyjny</label>
        <input type="text" id="register-nb" placeholder="opcjonalnie">
    
        <label for="arrival-purpose">Cel przybycia</label>
        <textarea id="arrival-purpose" placeholder="np. Spotkanie, Prace serwisowe itp."></textarea>
    
        <div id="guests-form">
            <label for="guest-fname">Imię</label>
            <input type="text" id="guest-fname">
    
            <label for="guest-lname">Nazwisko</label>
            <input type="text" id="guest-lname">
    
            <button id="add-guest" onclick="addGuest()">Dodaj</button>
    
            <table id="guests-table">
            <thead>
                <tr>
                    <th style="display: none"></th>
                    <th>Imię</th>
                    <th>Nazwisko</th>
                    <th>Akcja</th>
                </tr>
            </thead>
            <tbody id="guest-table-body"></tbody>
            </table>
        </div>

        <div id="hosts-form">
            <input list="hosts" id="hosts-list">
            <datalist id="hosts">
                {% for host in hosts_data %}
                    <option value="{{host.firstname}} {{host.lastname}}">
                {% endfor %}
            </datalist>
            <button id="add-host" onclick="addHost()">Dodaj</button>

            <table id="hosts-table">
                <thead>
                    <tr>
                        <th style="display: none">TEST</th>
                        <th>Imię</th>
                        <th>Nazwisko</th>
                        <th>Akcja</th>
                    </tr>
                </thead>
                <tbody id="host-table-body"></tbody>
            </table>
        </div>

        <div id="meetings-form">
            <button id="meeting-details-button" onclick="document.getElementById('meeting-details-modal').style.display='block'">Dodaj spotkanie</button>
            <div id="meeting-details-modal" class="details-modal">
                <div class="modal-content">
                    <span class="close" onclick="document.getElementById('meeting-details-modal').style.display='none'">&times;</span>
                    <h2>Dostępne spotkania</h2>
                    <table>
                    <thead>
                        <tr>
                            <th style="display: none"></th>
                            <th>Przewodniczący</th>
                            <th>Data</th>
                            <th>Czas rozpoczęcia</th>
                            <th>Czas zakończenia</th>
                            <th>Opis</th>
                        </tr>
                    </thead>
                    <tbody id="add-meeting-table-body">
                        {% for meeting in meetings_data %}
                            <tr class="meeting-detail">
                                <td style="display: none;">{{meeting.id}}</td>
                                <td>{% for leader in meeting.leaders %}{{ leader.firstname }} {{ leader.lastname }}, {% endfor %}</td>
                                <td>{{meeting.date}}</td>
                                <td>{{meeting.start_time}}</td>
                                <td>{{meeting.end_time}}</td>
                                <td>{{meeting.description}}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    </table>

                </div>
            </div>
            <table id="meetings-table">
                <thead>
                    <tr>
                        <th style="display: none"></th>
                        <th>Data</th>
                        <th>Czas rozpoczęcia</th>
                        <th>Czas zakończenia</th>
                        <th>Opis</th>
                        <th>Akcja</th>
                    </tr>
                </thead>
                <tbody id="meeting-table-body"></tbody>
            </table>
        </div>

        <input type="submit" value="Akceptuj" onclick="postGuestData()">

    </div>

    <h1>TEST PART</h1>
    {% for guest in registered_guests_data %}
    <p>{{guest}}</p>
    {% endfor %}

    {{ hosts_data|json_script:"hosts_data_json" }}
    {{ companies_data|json_script:"companies_data_json" }}
    {{ registered_guests_data|json_script:"registered_guests_data_json" }}
  
    <script>

        let hosts_data_json;
        let companies_data_json;
        let registered_guests_data_json;

        let companyNameInput;
        let registerNumberInput;
        let descriptionInput;
        let guestTableInput;
        let hostTableInput;
        let meetingTableInput;

        document.addEventListener("DOMContentLoaded", (event) => {

            hosts_data_json = JSON.parse(document.getElementById('hosts_data_json').textContent);
            companies_data_json = JSON.parse(document.getElementById('companies_data_json').textContent);
            registered_guests_data_json = JSON.parse(document.getElementById('registered_guests_data_json').textContent);

            companyNameInput = document.getElementById("companies-list");
            registerNumberInput = document.getElementById("register-nb");
            descriptionInput = document.getElementById("arrival-purpose");
            guestTableInput = document.getElementById("guest-table-body");
            hostTableInput = document.getElementById("host-table-body");
            meetingTableInput = document.getElementById("meeting-table-body");

            const meetingDetailsList = document.getElementsByClassName("meeting-detail");
            Array.from(meetingDetailsList).forEach(element => {
                element.addEventListener("click", () => addMeeting(element));
            });
        });

        function getDataFromTable(tableBody) {
            let values = [];
            for (let row of tableBody.childNodes) {
                console.log("NSOAIDOIA", row);
                value = []
                for (let el of Array.from(row.childNodes).slice(0, -1)) {
                    value.push(el.textContent);
                }
                values.push(value);
            }
            return values;
        }

        function getGuestsData() {
            
        }

        function postGuestData() {
            let companyValue = companyNameInput.value;
            let registerNbValue = registerNumberInput.value;
            let descriptionValue = descriptionInput.value;
            let guestsValues = getDataFromTable(guestTableInput);
            let hostsValues = getDataFromTable(hostTableInput);
            let meetingsValues = getDataFromTable(meetingTableInput);

            if (!validateCompany(companyValue)) {
                alert("Nieprawidłowa nazwa firmy!");
                companyNameInput.textContent = "";
                return;
            }

            if (!validateRegisterNb(registerNbValue)) {
                alert("Nieprawidłowy numer tablicy rejestracyjnej!");
                registerNumberInput.textContent = "";
                return;
            }

            if (descriptionValue.length === 0) {
                alert("Nie podano celu przybycia");
                return;
            }

            if (guestsValues.length === 0) {
                alert("Musisz wprowadzić dane przynajmniej jednego gościa!");
                return;
            }

            if (hostsValues.length === 0) {
                alert("Musisz wprowadzić dane przynajmniej jednego gospodarza!");
                return;
            }
            sendFormToServer({
                'company': companyValue,
                'register_number': registerNbValue,
                'description': descriptionValue,
                'guests': guestsValues.map(guest => ({'id': guest[0], 'firstname': guest[1], 'lastname': guest[2]})),
                'hosts': hostsValues.map(host => ({'id': host[0], 'firstname': host[1], 'lastname': host[2]})),
                'meetings': meetingsValues.map(meeting => ({'id': meeting[0], 'start_time': meeting[2], 'end_time': meeting[3], 'date': meeting[1], 'description': meeting[4]}))
            })
        }

        function sendFormToServer(json) {
            // TODO
            console.log(json);
        }

        function validateCompany(name) {
            return (companies_data_json.map(comp_data => comp_data.name)).includes(name);
        }

        function validateRegisterNb(registerNb) {
            // TODO
            return true;
        }

        // function getAllFields() {
        //     return {
        //         "company": 
        //     }
        // }

        function addMeeting(meeting_data) {
            const MAX_MEETING_DESCRIPTION_LENGTH = 50

            let id = meeting_data.children[0].textContent;
            let date = meeting_data.children[2].textContent;
            let start_time = meeting_data.children[3].textContent;
            let end_time = meeting_data.children[4].textContent;
            let description = meeting_data.children[5].textContent.substring(0, MAX_MEETING_DESCRIPTION_LENGTH-3) + "...";

            //shortened_meeting_data = meeting_data.substring(0, MAX_MEETING_DATA_LENGTH-3) + '...'
            
            const newMeetingRow = document.createElement("tr");
            //newMeetingRow.appendChild(createTextTableField(shortened_meeting_data));   
    
            newMeetingRow.appendChild(createTextTableField(id, display='none'));   
            newMeetingRow.appendChild(createTextTableField(date));   
            newMeetingRow.appendChild(createTextTableField(start_time));   
            newMeetingRow.appendChild(createTextTableField(end_time));   
            newMeetingRow.appendChild(createTextTableField(description));   
            newMeetingRow.appendChild(createActionTableButton());
    
            let meetingTableBody = document.getElementById("meeting-table-body");
            meetingTableBody.appendChild(newMeetingRow);

            document.getElementById("meeting-details-modal").style.display='none';
        }

        function addHost() {
            HOST_REGEX = /(\p{L}+) (\p{L}+)/u;
            let hostNode = document.getElementById("hosts-list");
            const host = hostNode.value;
            let match = host.match(HOST_REGEX);
            if (!match) {
                alert("Błędny format danych gospodarza")
                return;
            }

            //const id = parseInt(match[1]); // TIDI
            const fname = match[1];
            const lname = match[2];
            const id = registeredHostId(fname, lname);
            console.log(fname, lname, id);

            if (!(hosts_data_json.map(host => host.id)).includes(id)) {
                // wrong value!
                alert("Podano nieprawidłowe dane gospodarza");
                hostNode.textContent = "";
                return;
            }

//            const host_to_add = hosts_data_json.filter(host => host.id===id)[0];
    
            const newHostRow = document.createElement("tr");
    
            newHostRow.appendChild(createTextTableField(id, display='none'));
            newHostRow.appendChild(createTextTableField(fname));
            newHostRow.appendChild(createTextTableField(lname));    
            newHostRow.appendChild(createActionTableButton());
    
            let hostTableBody = document.getElementById("host-table-body");
            hostTableBody.appendChild(newHostRow);
    
            hostNode.value = "";
        }
        
        function addGuest() {
            let fnameNode = document.getElementById("guest-fname");
            const fname = fnameNode.value;
            let lnameNode = document.getElementById("guest-lname");
            const lname = lnameNode.value;
            console.log(fname);
            console.log(lname);
            if (!fname || !lname) {
            alert("Proszę wpisać imię i nazwisko.");
            return;
            }
    
            const newGuestRow = document.createElement("tr");

            const id = registeredGuestId(fname, lname);

            if (id === -1) {
                alert("Wprowadzony gość nie istnieje w systemie i zostanie utworzony. Jeśli to błąd - usuń gościa z listy");
            }

            newGuestRow.appendChild(createTextTableField(id, display='none'));
            newGuestRow.appendChild(createTextTableField(fname));
            newGuestRow.appendChild(createTextTableField(lname));
            newGuestRow.appendChild(createActionTableButton());
    
            let guestTableBody = document.getElementById("guest-table-body");
            guestTableBody.appendChild(newGuestRow);
    
            fnameNode.value = "";
            lnameNode.value = "";
        }

        function registeredGuestId(firstname, lastname) {
            for (let guest of registered_guests_data_json) {
                if (guest.firstname === firstname && guest.lastname === lastname) {
                    return guest.id;
                }
            }
            return -1;
        }

        function registeredHostId(firstname, lastname) {
            for (let host of hosts_data_json) {
                if (host.firstname === firstname && host.lastname === lastname) {
                    return host.id;
                }
            }
            return -1;
        }

        function createTextTableField(text, display='') {
            let tableNode = document.createElement("td");
            tableNode.textContent = text;
            tableNode.style.display = display;
            return tableNode;
        }

        function createActionTableButton() {
            let actionTableNode = document.createElement("td");
            let actionNode = document.createElement("button");
            actionNode.textContent = "-";
            actionNode.onclick = function() {this.parentNode.parentNode.remove();};
            actionTableNode.appendChild(actionNode);
            return actionTableNode;
        }
    </script>
{% endblock %}
